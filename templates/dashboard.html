{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}

<h2 class="mb-4">Your Jobs</h2>

<!-- Summary counts -->
<div class="mb-3">
  <strong>Summary:</strong>
  Applied: {{ counts['Applied'] }} |
  Interview: {{ counts['Interview'] }} |
  Offer: {{ counts['Offer'] }} |
  Rejected: {{ counts['Rejected'] }} |
  Total: {{ counts['Total'] }}
</div>

<!-- Status Pie + quick rates -->
<div class="row mb-4">
  <div class="col-md-6">
    <canvas id="statusPie"></canvas>
  </div>
  <div class="col-md-6">
    <h5>Rates</h5>
    <p>Interview rate: {{ rates.interview_rate if rates else 0 }}%</p>
    <p>Offer rate: {{ rates.offer_rate if rates else 0 }}%</p>
  </div>
</div>

<!-- Filters -->
<form method="get" action="{{ url_for('jobs.dashboard') }}" class="row g-3 mb-4">
  <div class="col-md-3">
    <label class="form-label">Status</label>
    <select class="form-select" name="status">
      <option value="" {{ '' == status and 'selected' or '' }}>All</option>
      {% for s in ["Applied","Interview","Offer","Rejected"] %}
        <option value="{{ s }}" {{ s == status and 'selected' or '' }}>{{ s }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">Search</label>
    <input type="text" class="form-control" name="q" value="{{ q or '' }}" placeholder="company or role">
  </div>
  <div class="col-md-3">
    <label class="form-label">Month</label>
    <input type="month" class="form-control" name="month" value="{{ month or '' }}">
  </div>
  <div class="col-md-3 d-flex align-items-end">
    <button class="btn btn-primary me-2" type="submit">Filter</button>
    <a class="btn btn-secondary" href="{{ url_for('jobs.dashboard') }}">Reset</a>
  </div>
</form>

{% if jobs %}
  <table class="table table-bordered table-striped">
    <thead class="table-dark">
      <tr>
        <th>Company</th>
        <th>Role</th>
        <th>Status</th>
        <th>Applied On</th>
        <th>Link</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for j in jobs %}
        <tr>
          <td>{{ j.company }}</td>
          <td>{{ j.role }}</td>
          <td>{{ j.status }}</td>
          <td>{{ j.applied_on or "" }}</td>
          <td>{% if j.link %}<a href="{{ j.link }}" target="_blank">Open</a>{% endif %}</td>
          <td>
            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('jobs.edit_form', job_id=j.id) }}">Edit</a>
            <form action="{{ url_for('jobs.delete', job_id=j.id) }}" method="post" style="display:inline" onsubmit="return confirm('Delete this job?');">
              <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
            </form>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if page_obj and page_obj.pages > 1 %}
    <nav>
      <ul class="pagination">
        {% if page_obj.has_prev %}
          <li class="page-item"><a class="page-link" href="{{ url_for('jobs.dashboard', page=page_obj.prev_num, status=status, q=q, month=month) }}">« Prev</a></li>
        {% endif %}
        <li class="page-item disabled"><span class="page-link">Page {{ page_obj.page }} / {{ page_obj.pages }}</span></li>
        {% if page_obj.has_next %}
          <li class="page-item"><a class="page-link" href="{{ url_for('jobs.dashboard', page=page_obj.next_num, status=status, q=q, month=month) }}">Next »</a></li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}
{% else %}
  <p class="text-muted">No jobs match your filters.</p>
{% endif %}

<!-- Bar chart -->
<div style="max-width: 720px; margin: 20px 0;">
  <canvas id="appsPerMonth"></canvas>
</div>

{% endblock %}
